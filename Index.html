<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      background: radial-gradient(circle at top, #f5f7ff 0%, #d9defa 40%, #141432 100%);
      padding: 24px;
      font-family: system-ui, sans-serif;
      display: flex;
      justify-content: center;
    }
    .container { background:white; padding:24px; border-radius:24px; max-width:1200px; width:100%; }
    .title-row { display:flex; justify-content:space-between; align-items:center; }
    .title-text { font-size:32px; font-weight:700; color:#1f2431; }
    .all-map-btn {
      background:#2563eb; color:white; padding:10px 18px;
      border-radius:999px; cursor:pointer; border:none;
      display:flex; align-items:center; gap:8px;
    }
    .clusters-column { margin-top:24px; max-height:600px; overflow-y:auto; }
    .cluster-card { padding:16px; background:white; border-radius:16px; margin-bottom:16px; box-shadow:0 8px 24px rgba(0,0,0,0.08); }
  </style>
</head>

<body>
  <div class="container">
    <div class="title-row">
      <div class="title-text">Site Visit Planner</div>
      <button id="all-map-btn" class="all-map-btn" disabled>üó∫Ô∏è View all in Google Maps</button>
    </div>

    <div class="stats-box" style="display:flex; gap:24px; margin-top:24px;">
      <div class="stat"><div>TOTAL SITES</div><div id="total-sites" style="font-size:24px;font-weight:700;">0</div></div>
      <div class="stat"><div>CLUSTERS</div><div id="total-clusters" style="font-size:24px;font-weight:700;">0</div></div>
      <div class="stat"><div>EST. DRIVE TIME</div><div id="total-time" style="font-size:24px;font-weight:700;">0m</div></div>
    </div>

    <div class="clusters-column" id="clusters-list"></div>
  </div>

  <script>
    google.script.run.withSuccessHandler(renderPlanner).getVisitData();

    function renderPlanner(payload) {
      const rows = [...payload.rows].sort((a,b)=>a.minutes - b.minutes);
      const office = payload.office;

      document.getElementById("total-sites").textContent = rows.length;
      document.getElementById("total-clusters").textContent = new Set(rows.map(r=>r.cluster)).size;

      const totalMinutes = rows.reduce((a,r)=>a + (r.minutes||0),0);
      document.getElementById("total-time").textContent = Math.floor(totalMinutes/60)+'h '+(totalMinutes%60)+'m';

      const allBtn = document.getElementById("all-map-btn");
      google.script.run.withSuccessHandler(url=>{
        if(url){ allBtn.disabled=false; allBtn.onclick=()=>window.open(url,'_blank'); }
      }).buildMultiRouteUrl(office, rows);

      const list = document.getElementById("clusters-list");
      list.innerHTML = rows.map(r=>`
        <div class="cluster-card">
          <div><strong>${r.cluster}</strong></div>
          <div>${r.site}</div>
          <div>Deal ${r.deal}</div>
          <div>${r.duration} ‚Ä¢ ${r.distance}</div>
          <button onclick="window.open('${r.link}','_blank')" class="all-map-btn" style="margin-top:8px;">Open route</button>
        </div>
      `).join('');
    }
  </script>
</body>
</html>
